{"name":"Dblite","tagline":"sqlite for node.js without gyp problems","body":"dblite\r\n======\r\na zero hassle wrapper for sqlite\r\n```javascript\r\nvar dblite = require('dblite'),\r\n    db = dblite('file.name');\r\n\r\n// Asynchronous, fast, and ...\r\ndb.query('SELECT * FROM table', function(rows) {\r\n  // ... that easy!\r\n});\r\n```\r\nMore in [the related blogpost](http://webreflection.blogspot.com/2013/07/dblite-sqlite3-for-nodejs-made-easy.html) and here too :-)\r\n\r\n[![NPM](https://nodei.co/npm/dblite.png?downloads=true)](https://nodei.co/npm/dblite/)\r\n\r\n\r\n### The What And The Why\r\nI've created `dblite` module because there's still not a simple and straight forward or standard way to have [sqlite](http://www.sqlite.org) in [node.js](http://nodejs.org) without requiring to re-compile, re-build, download sources a part or install dependencies instead of simply `apt-get install sqlite3` or `pacman -S sqlite3` in your \\*nix system.\r\n\r\n`dblite` has been created with portability, simplicity, and reasonable performance for **embedded Hardware** such [Raspberry Pi](http://www.raspberrypi.org) and [Cubieboard](http://cubieboard.org) in mind.\r\n\r\nGenerally speaking all linux based distributions like [Arch Linux](https://www.archlinux.org), where is not always that easy to `node-gyp` a module and add dependencies that work, can now use this battle tested wrap and perform basic to advanced sqlite operations.\r\n\r\n\r\n### Bootstrap\r\nTo install dblite simply `npm install dblite` then in node:\r\n```javascript\r\nvar dblite = require('dblite'),\r\n    db = dblite('/folder/to/file.sqlite');\r\n\r\n// ready to go, i.e.\r\ndb.query('.databases');\r\ndb.query(\r\n  'SELECT * FROM users WHERE pass = ?',\r\n  [pass],\r\n  function (rows) {\r\n    var user = rows.length && rows[0];\r\n  }\r\n);\r\n```\r\nBy default the `dblite` function uses **sqlite3 as exacutable**. If you need to change the path simply update `dblite.bin = \"/usr/local/bin/sqlite3\";` before invoking the function.\r\n\r\n\r\n### API\r\nRight now a created `EventEmitter` `db` instance has 3 extra methods: `.query()`, `.lastRowID()`, and `.close()`.\r\n\r\nThe `.lastRowID(table, callback(rowid))` helper simplifies a common operation with SQL tables after inserts, handful as shortcut for the following query:\r\n`SELECT ROWID FROM ``table`` ORDER BY ROWID DESC LIMIT 1`.\r\n\r\nThe method `.close()` does exactly what it suggests: it closes the database connection.\r\nPlease note that it is **not possible to perform other operations once it has been closed**.\r\n\r\nBeing an `EventEmitter` instance, the database variable will be notified with the `close` listener, if any.\r\n\r\n\r\n### Understanding The .query() Method\r\nThe main role in this module is played by the `db.query()` method, a method rich in overloads all with perfect and natural meaning.\r\n\r\nThe amount of parameters goes from one to four, left to right, where left is the input going through the right which is the eventual output.\r\n\r\nAll parameters are optionals except the SQL one.\r\n\r\n### db.query() Possible Combinations\r\n```javascript\r\ndb.query(SQL)\r\ndb.query(SQL, callback:Function)\r\ndb.query(SQL, params:Array|Object)\r\ndb.query(SQL, fields:Array|Object)\r\ndb.query(SQL, params:Array|Object, callback:Function)\r\ndb.query(SQL, fields:Array|Object, callback:Function)\r\ndb.query(SQL, params:Array|Object, fields:Array|Object)\r\ndb.query(SQL, params:Array|Object, fields:Array|Object, callback:Function)\r\n```\r\nAll above combinations are [tested properly in this file](test/dblite.js) together with many other tests able to make `dblite` robust enough and ready to be used.\r\n\r\nPlease note how `params` is always before `fields` and/or `callback` if `fields` is missing, just as reminder that order is left to right accordingly with what we are trying to do.\r\n\r\nFollowing detailed explanation per each parameter.\r\n\r\n#### The SQL:string\r\nThis string [accepts any query understood by SQLite](http://www.sqlite.org/lang.html) plus it accepts all commands that regular SQLite shell would accept such `.databases`, `.tables`, `.show` and all others passing through the specified `info` listener, if any, using just the console as fallback otherwise.\r\n```javascript\r\nvar dblite = require('dblite'),\r\n    db = dblite('./db.sqlite');\r\n\r\n// will call the implicit `info` console.log\r\ndb.query('.show');\r\n/* will console.log something like:\r\n\r\n     echo: off\r\n  explain: off\r\n  headers: off\r\n     mode: csv\r\nnullvalue: \"\"\r\n   output: stdout\r\nseparator: \",\"\r\n    stats: off\r\n    width:\r\n*/\r\n\r\n// normal query\r\ndb.query('CREATE TABLE IF NOT EXISTS test (id INTEGER PRIMARY KEY, value TEXT)');\r\ndb.query('INSERT INTO test VALUES(null, ?)', ['some text']);\r\ndb.query('SELECT * FROM test');\r\n// will implicitly log the following\r\n// [ [ '1', 'some text' ] ]\r\n```\r\n\r\n#### The params:Array|Object\r\nIf the SQL string **contains special chars** such `?`, `:key`, `$key`, or `@key` properties, these will be replaced accordingly with the `params` `Array` or `Object` that, in this case, MUST be present.\r\n```javascript\r\n// params as Array\r\ndb.query('SELECT * FROM test WHERE id = ?', [1]);\r\n\r\n// params as Object\r\ndb.query('SELECT * FROM test WHERE id = :id', {id:1});\r\n// same as\r\ndb.query('SELECT * FROM test WHERE id = $id', {id:1});\r\n// same as\r\ndb.query('SELECT * FROM test WHERE id = @id', {id:1});\r\n```\r\n\r\n#### The fields:Array|Object\r\nBy default, results are returned as an `Array` where all rows are the outer `Array` and each single row is another `Array`.\r\n```javascript\r\ndb.query('SELECT * FROM test');\r\n// will log something like:\r\n[\r\n  [ '1', 'some text' ],     // row1\r\n  [ '2', 'something else' ] // rowN\r\n]\r\n```\r\nIf we specify a fields parameter we can have each row represented by an object, instead of an array.\r\n```javascript\r\n// same query using fields as Array\r\ndb.query('SELECT * FROM test', ['key', 'value']);\r\n// will log something like:\r\n[\r\n  {key: '1', value: 'some text'},     // row1\r\n  {key: '2', value: 'something else'} // rowN\r\n]\r\n```\r\n\r\n#### Parsing Through The fields:Object\r\n[SQLite Datatypes](http://www.sqlite.org/datatype3.html) are different from JavaScript plus SQLite works via affinity.\r\nThis module also parses sqlite3 output which is **always a string** and as string every result will always be returned **unless** we specify `fields` parameter as object, suggesting validation per each field.\r\n```javascript\r\n// same query using fields as Object\r\ndb.query('SELECT * FROM test', {\r\n  key: Number,\r\n  value: String\r\n});\r\n// note the key as integer!\r\n[\r\n  {key: 1, value: 'some text'},     // row1\r\n  {key: 2, value: 'something else'} // rowN\r\n]\r\n```\r\nMore complex validators/transformers can be passed without problems:\r\n```javascript\r\n// same query using fields as Object\r\ndb.query('SELECT * FROM `table.users`', {\r\n  id: Number,\r\n  name: String,\r\n  adult: Boolean,\r\n  skills: JSON.parse,\r\n  birthday: Date,\r\n  cube: function (fieldValue) {\r\n    return fieldValue * 3;\r\n  }\r\n});\r\n```\r\n\r\n#### The params:Array|Object AND The fields:Array|Object\r\nNot a surprise we can combine both params, using the left to right order input to output so **params first**!\r\n```javascript\r\n// same query using params AND fields\r\ndb.query('SELECT * FROM test WHERE id = :id', {\r\n  id: 1\r\n},{\r\n  key: Number,\r\n  value: String\r\n});\r\n\r\n// same as...\r\ndb.query('SELECT * FROM test WHERE id = ?', [1], ['key', 'value']);\r\n// same as...\r\ndb.query('SELECT * FROM test WHERE id = ?', [1], {\r\n  key: Number,\r\n  value: String\r\n});\r\n// same as...\r\ndb.query('SELECT * FROM test WHERE id = :id', {\r\n  id: 1\r\n}, [\r\n  'key', 'value'\r\n]);\r\n```\r\n\r\n#### The callback:Function\r\nWhen a `SELECT` or a `PRAGMA` `SQL` is executed the module puts itself in a *waiting for results* state.\r\n\r\n**Update** - Starting from `0.3.3` every other `SQL` statement will invoke the callback after the operation has been completed.\r\n\r\nAs soon as results are fully pushed to the output the module parses this result, if any, and send it to the specified callback.\r\n\r\nThe callback is **always the last specified parameter**, if any, or the implicit equivalent of `console.log.bind(console)`.\r\nLatter case is simply helpful to operate directly via `node` **console** and see results without bothering writing a callback each `.query()` call.\r\n\r\n#### Extra Bonus: JSON Serialization With fields:Array|Object\r\nIf one field value is not scalar (boolean, number, string, null) `JSON.stringify` is performed in order to save data.\r\nThis helps lazy developers that don't want to pre parse every field and let `dblite` do the magic.\r\n```javascript\r\n// test has two fields, id and value\r\ndb.query('INSERT INTO test VALUES(?, ?)', [\r\n  123,\r\n  {name: 'dblite', rate: 'awesome'} // value serialized\r\n]);\r\n\r\n// use the fields to parse back the object\r\ndb.query('SELECT * FROM test WHERE id = ?', [123], {\r\n  id: Number,\r\n  value: JSON.parse // value unserialized\r\n}, function (rows) {\r\n  var record = rows[0];\r\n  console.log(record.id); // 123\r\n  console.log(record.value.name); // \"dblite\"\r\n  console.log(record.value.rate); // \"awesome\"\"\r\n});\r\n```\r\n\r\n### Automatic Fields Through Headers\r\nSince version `0.3.0` it is possible to enable automatic fields parsing either through initialization (suggested) or at runtime.\r\n```javascript\r\nvar dblite = require('dblite'),\r\n    // passing extra argument at creation\r\n    db = dblite('file.name', '-header');\r\n\r\ndb.query('SELECT * FROM table', function(rows) {\r\n  rows[0]; // {header0: value0, headerN: valueN}\r\n});\r\n\r\n// at runtime\r\ndb\r\n  .query('.headers ON')\r\n  .query('SELECT * FROM table', function(rows) {\r\n    rows[0]; // {header0: value0, headerN: valueN}\r\n  })\r\n  .query('.headers OFF')\r\n;\r\n```\r\n\r\nIn version `0.3.2` a smarter approach for combined _headers/fields_ is used where the right key order is granted by headers but it's possible to validate known fields too.\r\n\r\n```javascript\r\nvar db = require('dblite')('file.name', '-header');\r\n\r\ndb.query('SELECT 1 as one, 2 as two', {two:Number}, function(rows) {\r\n  rows[0]; // {one: \"1\", two: 2} // note \"1\" as String\r\n});\r\n```\r\nIn this way these two options can be supplementary when and if necessary.\r\n\r\n\r\n### Handling Infos And Errors - Listeners\r\nThe `EventEmitter` will notify any listener attached to `info`, `error`, or `close` accordingly with the current status.\r\n```javascript\r\ndb.on('info', function (data) {\r\n  // show data returned by special syntax\r\n  // such: .databases .tables .show and others\r\n  console.log(data);\r\n  // by default, it does the same\r\n});\r\n\r\ndb.on('error', function (message) {\r\n  // same as `info` but for errors\r\n  console.error(message);\r\n  // by default, it does the same\r\n});\r\n\r\ndb.on('close', function (code) {\r\n  // by default, it logs \"bye bye\"\r\n  // invoked once the database has been closed\r\n  // and every statement in the queue executed\r\n  // the code is the exit code returned via SQLite3\r\n  // usually 0 if everything was OK\r\n  console.log('safe to get out of here ^_^_');\r\n});\r\n```\r\nThe `close` event ensures that all operations have been successfully performed and your app is ready to exit or move next.\r\n\r\nPlease note that after invoking `db.close()` any other query will be ignored and the instance will be put in a _waiting to complete_ state which will invoke the `close` listener once operations have been completed.\r\n\r\n\r\n### Raspberry Pi Performance\r\nThis is the output generated after a `make test` call in this repo folder within Arch Linux for RPi.\r\n```\r\nnpm test\r\n\r\n> dblite@0.1.2 test /home/dblite\r\n> node test/.test.js\r\n\r\n/home/dblite/dblite.test.sqlite\r\n------------------------------\r\nmain\r\npasses: 1, fails: 0, errors: 0\r\n------------------------------\r\ncreate table if not exists\r\npasses: 1, fails: 0, errors: 0\r\n------------------------------\r\n100 sequential inserts\r\n100 records in 3.067 seconds\r\npasses: 1, fails: 0, errors: 0\r\n------------------------------\r\n1 transaction with 100 inserts\r\n200 records in 0.178 seconds\r\npasses: 1, fails: 0, errors: 0\r\n------------------------------\r\nauto escape\r\npasses: 1, fails: 0, errors: 0\r\n------------------------------\r\nauto field\r\nfetched 201 rows as objects in 0.029 seconds\r\npasses: 1, fails: 0, errors: 0\r\n------------------------------\r\nauto parsing field\r\nfetched 201 rows as normalized objects in 0.038 seconds\r\npasses: 1, fails: 0, errors: 0\r\n------------------------------\r\nmany selects at once\r\ndifferent selects in 0.608 seconds\r\npasses: 1, fails: 0, errors: 0\r\n------------------------------\r\ndb.query() arguments\r\n[ [ '1' ] ]\r\n[ [ '2' ] ]\r\n[ { id: 1 } ]\r\n[ { id: 2 } ]\r\npasses: 5, fails: 0, errors: 0\r\n------------------------------\r\nutf-8\r\n¥ · £ · € · $ · ¢ · ₡ · ₢ · ₣ · ₤ · ₥ · ₦ · ₧ · ₨ · ₩ · ₪ · ₫ · ₭ · ₮ · ₯ · ₹\r\npasses: 1, fails: 0, errors: 0\r\n------------------------------\r\nerease file\r\npasses: 1, fails: 0, errors: 0\r\n\r\n------------------------------\r\n          15 Passes\r\n------------------------------\r\n```\r\nIf an SD card can do this good, I guess any other environment should not have problems here ;-)\r\n\r\n### F.A.Q.\r\nHere a list of probably common Q&A about this module. Please do not hesitate to ask me more, if necessary, thanks.\r\n\r\n  * **How Does It Work?** `dblite` uses a [spawned](http://nodejs.org/api/child_process.html#child_process_child_process_spawn_command_args_options) version of the `sqlite3` executable. It could theoretically work with any other SQL like database but it's tested with `sqlite3-shell` only\r\n  * **Does It Spawn Per Each Query?** this is a quick one: **NO**! `dblite` spawns once per each database file where usually there is only one database file opened per time.\r\n  * **How About Memory And Performance?** Accordingly with `node` manual:\r\n  \r\n    > These child Nodes are still whole new instances of V8.\r\n    > Assume at least 30ms startup and 10mb memory for each new Node.\r\n    > That is, you cannot create many thousands of them.\r\n  \r\n    Since `dblite` spawns only once, there is a little overhead during the database initialization but that's pretty much it, the amount of RAM increases with the amount of data we save or retrieve from the database. The above **Raspberry Pi Benchmark** should ensure that with most common operation, and using transactions where possible, latency and RAM aren't a real issue.\r\n  * **Why Not The Native One?** I had some difficulty installing this [node-sqlite3 module](https://github.com/developmentseed/node-sqlite3#name) due `node-gyp` incompatibilities with some **ARM** based device in both *Debian* and *ArchLinux*. Since I really needed an sqlite manager for the next version of [polpetta](https://github.com/WebReflection/polpetta#က-polpetta) which aim is to have a complete, lightweight, and super fast web server in many embedded hardware such RPi, Cubieboard, and others, and since I needed something able to work with multiple core too, I've decided to try this road wrapping the native, easy to install and update, `sqlite3` shell client and do everything I need. So far, so good I would say ;-)\r\n  * **Isn't `params` and `fields` an ambiguous choice?** At the very beginning I wasn't sure myself if that would have worked as API choice but later on I've changed my mind. First of all, it's very easy to spot special chars in the `SQL` statement. If present, params is mandatory and used, as easy as that. Secondly, if an object has functions as value, it's obviously a `fields` object, 'cause `params` cannot contains functions since these are not compatible with `JSON` serialization, neither meaningful for the database. The only case where `fields` might be confused with `params` is when no `params` has been specified, and `fields` is an `Array`. In this case I believe you are the same one that wrote the SQL too and know upfront if there are fields to retrieve from `params` or not so this is actually a *non real-world* problem and as soon as you try this API you'll realize it feels intuitive and right.\r\n  * **Are Transactions Supported?** ... **YES**, transactions are supported simply performing multiple queries as you would do in *sqlite3* shell:\r\n  ```javascript\r\n    db.query('BEGIN TRANSACTION');\r\n    for(var i = 0; i < 100; i++) {\r\n      db.query('INSERT INTO table VALUES(?, ?)', [null, Math.random()]);\r\n    }\r\n    db.query('COMMIT');\r\n  ```\r\n  The test file has a transaction with 100 records in it, [have a look](test/dblite.js).\r\n  * **Can I Connect To A `:memory:` Database?** well, you can do anything you would do with `sqlite3` shell so **YES**\r\n  ```javascript\r\n  var db = dblite(':memory:'); // that's it!\r\n  ```\r\n\r\n### License\r\nThe usual Mit Style, thinking about the [WTFPL](http://en.wikipedia.org/wiki/WTFPL) though ... stay tuned for updates.\r\n\r\n    Copyright (C) 2013 by WebReflection\r\n\r\n    Permission is hereby granted, free of charge, to any person obtaining a copy\r\n    of this software and associated documentation files (the \"Software\"), to deal\r\n    in the Software without restriction, including without limitation the rights\r\n    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\r\n    copies of the Software, and to permit persons to whom the Software is\r\n    furnished to do so, subject to the following conditions:\r\n\r\n    The above copyright notice and this permission notice shall be included in\r\n    all copies or substantial portions of the Software.\r\n\r\n    THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\n    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\n    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\n    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\n    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\n    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\r\n    THE SOFTWARE.\r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}